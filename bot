#!/usr/bin/env python

import sys
import logging
from threading import Thread
from code import interact

log = logging.getLogger('bot')

def load_flexo():
    names = [ n for n in sys.modules
                if n == 'flexo' or n.startswith('flexo.') ]
    for name in names:
        sys.modules[name] = reload(sys.modules[name])
    return __import__('flexo.irc').irc

def run_bot(context, bot_factory):
    bot = context['bot'] = bot_factory()
    bot.initialize()

    while not bot.reason:
        bot.run()

        if bot.reason == 'graceful':
            log.info('Gracefully reloading code')

            old_bot = bot

            try:
                bot = context['bot'] = bot_factory()
            except:
                log.exception('Graceful reload of code failed')
                bot.reinitialize(None)
                continue

            bot.reinitialize(old_bot)
            old_bot = None

def run_console(context):
    while True:
        interact(local=context)

def main(hostname='localhost', port=6667, debug=False):
    def bot_factory():
        irc = load_flexo()
        return irc.Bot((hostname, port))

    context = {}

    bot_thread = Thread(target=run_bot, name='Bot', args=(context, bot_factory))
    bot_thread.start()

    console_thread = Thread(target=run_console, name='Console', args=(context,))
    console_thread.start()

    bot_thread.join()
    sys.exit()

if __name__ == '__main__':
    import getopt

    kwargs = {}
    short_opts = 'dh:p:'

    opts, args = getopt.getopt(sys.argv[1:], short_opts)
    for opt, val in opts:
        if opt == '-d':
            kwargs['debug'] = True

        elif opt == '-h':
            kwargs['hostname'] = val
        elif opt == '-p':
            kwargs['port'] = int(val)

    log_format = '[%(asctime)s] %(name)s %(levelname)s %(message)s'

    logging.basicConfig(level=logging.DEBUG,
                        format=log_format,
                        filename='flexo.log')

    main(**kwargs)
